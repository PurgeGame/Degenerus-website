<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Degnerette Demo</title>
    <script type="module" crossorigin src="/assets/index-DWvMBOGD.js"></script>
    <link rel="stylesheet" crossorigin href="/assets/index-Cm-1x7xL.css">
    <link rel="stylesheet" href="/sim/enhanced-animations.css">
    <script src="/sim/animation-controller.js" defer></script>
    <style>
      .wallet-address.compact-hidden {
        display: none !important;
      }
      .discord-user.compact-hidden {
        display: none !important;
      }
      .connect-button.wallet-connected .btn-text {
        letter-spacing: 0.02em;
        font-variant-numeric: tabular-nums;
      }
      .connect-button.discord-connected .btn-text {
        letter-spacing: 0.01em;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="app-layout">
        <main class="main-column">
          <section class="panel top-bar">
            <div class="top-metrics">
              <div class="top-left">
                <div class="metric-group">
                  <div class="metric">
                    <span class="metric-label">Balance</span>
                    <span class="metric-value metric-value-with-icon">
                      <span id="currency-balance">0</span>
                      <img class="metric-icon-small" src="/badges-circular/crypto_00_xrp_red.svg" alt="WWXRP badge" />
                    </span>
                  </div>
                  <div class="metric">
                    <span class="metric-label">Score</span>
                    <span class="metric-value has-tooltip" id="activity-score">0%</span>
                  </div>
                </div>
              </div>
              <div class="app-title">
                <img class="title-badge" src="/badges-circular/flame_red.svg" alt="Flame badge" />
                <span>Degnerette Demo</span>
              </div>
              <div class="connect-group">
                <div class="connect-buttons">
                  <button id="discord-connect-btn" class="connect-button discord-button" type="button">
                    <span class="btn-icon" aria-hidden="true">
                      <svg viewBox="0 0 245 240" role="img" aria-hidden="true">
                        <path fill="currentColor" d="M104.4 104.9c-5.7 0-10.2 5-10.2 11.1 0 6.1 4.6 11.1 10.2 11.1 5.7 0 10.2-5 10.2-11.1.1-6.1-4.5-11.1-10.2-11.1zm36.2 0c-5.7 0-10.2 5-10.2 11.1 0 6.1 4.6 11.1 10.2 11.1 5.7 0 10.2-5 10.2-11.1 0-6.1-4.6-11.1-10.2-11.1z"/>
                        <path fill="currentColor" d="M189.5 20h-134C24.9 20 10 34.9 10 53.5v126.9C10 199 24.9 214 43.5 214h113.4l-5.3-18.5 12.8 11.9 12.1 11.2 21.4 19V53.5c0-18.6-14.9-33.5-33.4-33.5zM163 149.7s-4.6-5.5-8.4-10.3c16.7-4.7 23.1-15.1 23.1-15.1-5.2 3.4-10.1 5.8-14.5 7.4-6.3 2.7-12.3 4.5-18.2 5.5-12.2 2.3-23.4 1.7-33.1-.1-7.3-1.4-13.6-3.3-18.9-5.5-3-1.1-6.2-2.5-9.4-4.3-.4-.2-.8-.4-1.2-.6-.2-.1-.3-.2-.5-.3-2.2-1.2-3.4-2-3.4-2s6.2 10.2 22.6 15c-3.8 4.8-8.5 10.5-8.5 10.5-28.1-.9-38.8-19.3-38.8-19.3 0-41 18.4-74.2 18.4-74.2 18.4-13.8 35.9-13.4 35.9-13.4l1.3 1.5c-23 6.6-33.6 16.6-33.6 16.6s2.8-1.5 7.5-3.6c13.6-6 24.4-7.6 28.8-8 0.7-.1 1.3-.2 2-.2 7.2-1 15.3-1.3 23.7-.3 11.1 1.3 23 4.7 35.2 11.8 0 0-10-9.5-31.5-16.1l1.8-2c0 .1 17.5-.4 35.9 13.4 0 0 18.4 33.2 18.4 74.2 0 0-10.8 18.4-38.9 19.3z"/>
                      </svg>
                    </span>
                    <span class="btn-text" id="discord-connect-text">Discord</span>
                  </button>
                  <button id="wallet-connect-btn" class="connect-button metamask-button" type="button">
                    <span class="btn-icon" aria-hidden="true">
                      <svg viewBox="0 0 212 189" role="img" aria-hidden="true">
                        <polygon fill="currentColor" points="61.3,173.6 94.6,189 104.3,175.2 77.4,166.8"/>
                        <polygon fill="currentColor" points="150.7,173.6 134.5,166.8 107.8,175.2 117.4,189"/>
                        <polygon fill="currentColor" points="121.6,137.7 90.8,137.7 86.7,156.8 104.3,164.3 121.7,156.8"/>
                        <polygon fill="currentColor" points="144.7,47.6 124.5,63.2 150.6,75.2"/>
                        <polygon fill="currentColor" points="67.3,47.6 61.4,75.1 87.4,63.2"/>
                        <polygon fill="currentColor" points="58.3,83.4 47.5,114.1 87.4,111.9 86.2,92.1"/>
                        <polygon fill="currentColor" points="153.7,83.4 125.7,92.1 124.5,111.9 164.4,114.1"/>
                        <polygon fill="currentColor" points="48.5,120.5 62.2,162.2 86.7,156.8 83.8,136.1"/>
                        <polygon fill="currentColor" points="163.4,120.5 128.1,136.1 125.1,156.8 149.7,162.2"/>
                        <polygon fill="currentColor" points="87.4,117.7 83.8,136.1 90.8,137.7 104.3,125.5 104.3,117.7"/>
                        <polygon fill="currentColor" points="125.7,117.7 107.8,125.5 107.8,117.7 121.6,137.7 128.1,136.1"/>
                        <polygon fill="currentColor" points="48.5,39.1 87.4,63.2 83.7,47.6"/>
                        <polygon fill="currentColor" points="164.2,39.1 128.1,47.6 124.5,63.2"/>
                        <polygon fill="currentColor" points="87.4,63.2 104.3,79.4 121.6,63.2 104.3,53.4"/>
                        <polygon fill="currentColor" points="48.5,39.1 58.3,83.4 61.4,75.1"/>
                        <polygon fill="currentColor" points="164.2,39.1 150.6,75.2 153.7,83.4"/>
                      </svg>
                    </span>
                    <span class="btn-text" id="wallet-connect-text">Connect Wallet</span>
                  </button>
                </div>
                <div class="connect-status">
                  <span id="wallet-address" class="wallet-address">Not connected</span>
                  <div id="discord-user" class="discord-user hidden">
                    <img id="discord-avatar" alt="Discord avatar" />
                    <span id="discord-name"></span>
                  </div>
                </div>
                <div id="referral-row" class="referral-row hidden">
                  <span class="referral-label">Referral</span>
                  <input
                    id="referral-link"
                    class="referral-input"
                    type="text"
                    readonly
                    placeholder="Create referral link"
                  />
                  <button id="referral-action" class="secondary-button referral-action" type="button">Create</button>
                </div>
                <div id="affiliate-config" class="referral-row hidden">
                  <span class="referral-label">Affiliate</span>
                  <input
                    id="affiliate-code"
                    class="referral-input"
                    type="text"
                    maxlength="12"
                    placeholder="Choose code"
                    inputmode="text"
                    autocomplete="off"
                  />
                  <select id="affiliate-rakeback" class="referral-input">
                    <option value="0">Rakeback 0%</option>
                    <option value="500">Rakeback 5%</option>
                    <option value="1000">Rakeback 10%</option>
                    <option value="1500">Rakeback 15%</option>
                    <option value="2000">Rakeback 20%</option>
                    <option value="2500">Rakeback 25%</option>
                  </select>
                  <button id="affiliate-save" class="secondary-button" type="button">Save</button>
                </div>
                <div id="affiliate-status" class="wallet-address hidden"></div>
              </div>
            </div>
          </section>

          <!-- Selection Preview -->
          <section id="selection-panel" class="panel selection-panel">
            <div class="selection-compare">
              <div class="compare-col">
                <span class="compare-label">Your Selection</span>
                <div id="ft-player"></div>
                <span class="selection-hint">Click or scroll to edit</span>
              </div>
              <div class="compare-col">
                <span class="compare-label">House</span>
                <div id="ft-house"></div>
              </div>
            </div>
            <div class="selection-actions">
              <div class="center-actions">
                <div class="bet-inline">
                  <span class="metric-label">Bet</span>
                  <input
                    type="number"
                    id="ft-amount"
                    class="metric-input-field bet-input"
                    value="10"
                    step="1"
                    min="1"
                    inputmode="numeric"
                  />
                </div>
                <button id="spin-full" class="spin-button">SPIN</button>
              </div>
              <div class="net-result-box" id="net-result-box">
                <span class="net-label">Matches:</span>
                <span class="net-value" id="net-result-value">—</span>
                <span class="net-token" id="net-result-token">
                  <span class="net-token-value" id="net-result-token-value">—</span>
                  <span class="net-token-unit" id="net-result-token-unit">WWXRP</span>
                </span>
              </div>
            </div>
          </section>

          <div id="quick-selector" class="quick-selector hidden"></div>

          <!-- Results Panel with History Sidebar -->
          <section id="results-panel" class="panel">
            <h2>History</h2>
            <div class="results-layout">
              <div id="results-container" class="results-main">
                <p class="placeholder">No history yet</p>
              </div>
            </div>
          </section>

          <section id="leaderboard-panel" class="panel leaderboard-panel">
            <h2>Leaderboard</h2>
            <div id="leaderboard-list" class="leaderboard-list">
              <p class="placeholder">No leaderboard data yet</p>
            </div>
          </section>

        </main>
      </div>

      <footer>
        <p>Degenerette Simulator - For UI Development Only</p>
      </footer>
    </div>

    <script>
      (function () {
        window.__DEGEN__ = window.__DEGEN__ || {};

        const colors = ['pink', 'purple', 'green', 'red', 'blue', 'orange', 'silver', 'gold'];
        const categories = {
          crypto: ['xrp', 'tron', 'sui', 'monero', 'solana', 'chainlink', 'ethereum', 'bitcoin'],
          zodiac: ['aries', 'taurus', 'gemini', 'cancer', 'leo', 'libra', 'sagittarius', 'aquarius'],
          cards: ['club', 'diamond', 'heart', 'spade', 'horseshoe', 'cashsack', 'king', 'ace'],
          dice: ['1', '2', '3', '4', '5', '6', '7', '8'],
        };
        const cardOrder = [3, 4, 5, 6, 0, 2, 1, 7];
        const specials = [
          'special_eth.svg',
          'special_burnie.svg',
          'special_burnie_static.svg',
          'special_dgnrs.svg',
          'special_none.svg',
        ];

        function preloadBadges() {
          const urls = [];
          Object.keys(categories).forEach((category) => {
            categories[category].forEach((symbol, idx) => {
              const mapped = category === 'cards' ? cardOrder[idx] : idx;
              const idxStr = `0${mapped}`;
              colors.forEach((color) => {
                urls.push(`/badges-circular/${category}_${idxStr}_${symbol}_${color}.svg`);
              });
            });
          });
          specials.forEach((name) => {
            urls.push(`/specials/${name}`);
          });

          let i = 0;
          const batchSize = 6;
          const loadBatch = () => {
            let count = 0;
            while (i < urls.length && count < batchSize) {
              const img = new Image();
              img.decoding = 'async';
              img.src = urls[i];
              i += 1;
              count += 1;
            }
            if (i < urls.length) {
              setTimeout(loadBatch, 200);
            }
          };
          loadBatch();
        }

        function scrollQuadrant(quadrant, useColor) {
          const q = document.querySelector(`.gp-quadrant[data-quadrant="${quadrant}"]`);
          if (!q) return;
          const rect = q.getBoundingClientRect();
          const x = useColor ? rect.right - 6 : rect.left + rect.width * 0.3;
          const y = rect.top + rect.height / 2;
          q.dispatchEvent(new WheelEvent('wheel', {
            deltaY: 100,
            clientX: x,
            clientY: y,
            bubbles: true,
          }));
        }

        function setSpecial(target) {
          const special = document.querySelector('#ft-player .gamepiece-special-container');
          if (!special) return;
          special.click();
          setTimeout(() => {
            const selector = document.getElementById('quick-selector');
            if (!selector) return;
            const btn = selector.querySelector(`button[data-special="${target}"]`);
            if (btn) btn.click();
          }, 40);
        }

        function randomize() {
          const ftPlayer = document.getElementById('ft-player');
          if (!ftPlayer) return;
          for (let qIdx = 0; qIdx < 4; qIdx += 1) {
            const colorScrolls = 1 + Math.floor(Math.random() * 7);
            const symbolScrolls = 1 + Math.floor(Math.random() * 7);
            for (let i = 0; i < colorScrolls; i += 1) {
              scrollQuadrant(qIdx, true);
            }
            for (let i = 0; i < symbolScrolls; i += 1) {
              scrollQuadrant(qIdx, false);
            }
          }
          const targetSpecial = 1 + Math.floor(Math.random() * 3);
          setTimeout(() => setSpecial(targetSpecial), 60);
        }

        window.__DEGEN__.randomize = randomize;
        window.__DEGEN__.preloadBadges = preloadBadges;

        const schedule = (fn) => setTimeout(fn, 0);
        const autoRandomize = (retries = 10) => {
          const player = document.getElementById('ft-player');
          if (player) {
            randomize();
            return;
          }
          if (retries <= 0) return;
          setTimeout(() => autoRandomize(retries - 1), 200);
        };
        const startBackgroundTasks = () => {
          setTimeout(() => preloadBadges(), 1500);
          setTimeout(() => autoRandomize(), 1200);
        };
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => {
            schedule(startBackgroundTasks);
          }, { once: true });
        } else {
          schedule(startBackgroundTasks);
        }
      })();
    </script>

    <script>
      (function () {
        const affiliateRow = document.getElementById('affiliate-config');
        const status = document.getElementById('affiliate-status');
        const codeInput = document.getElementById('affiliate-code');
        const rakeSelect = document.getElementById('affiliate-rakeback');
        const saveBtn = document.getElementById('affiliate-save');
        const referralInput = document.getElementById('referral-link');
        const referralAction = document.getElementById('referral-action');
        if (!affiliateRow || !codeInput || !rakeSelect || !saveBtn) return;

        const apiBase = 'https://api.degener.us';
        let lastPlayerFetch = 0;
        let affiliateConfigured = false;

        function walletConnected() {
          const walletEl = document.getElementById('wallet-address');
          const text = walletEl?.textContent?.trim();
          return Boolean(text && text !== 'Not connected');
        }

        function discordConnected() {
          const discordEl = document.getElementById('discord-user');
          return Boolean(discordEl && !discordEl.classList.contains('hidden'));
        }

        function showStatus(message) {
          if (!status) return;
          status.textContent = message;
        }

        function setReferralLink(player) {
          if (!player?.referral_code || !referralInput) return;
          const link = `${window.location.origin}${window.location.pathname}?ref=${player.referral_code}`;
          referralInput.value = link;
          referralInput.placeholder = 'Affiliate link';
          if (referralAction) {
            referralAction.textContent = 'Copy';
            referralAction.dataset.mode = 'copy';
          }
        }

        function applyPlayer(player) {
          if (!player) return;
          const code = player.referral_code?.toString().trim().toUpperCase();
          affiliateConfigured = Boolean(code && /^[A-Z0-9]{3,12}$/.test(code));
          if (code) {
            codeInput.value = code;
            setReferralLink(player);
          }
          if (typeof player.affiliate_rakeback_bps === 'number') {
            rakeSelect.value = String(player.affiliate_rakeback_bps);
          }
          const showConfig = walletConnected() && discordConnected() && !affiliateConfigured;
          affiliateRow.classList.toggle('hidden', !showConfig);
          if (status) status.classList.toggle('hidden', !showConfig);

          if (player.referral_locked && !affiliateConfigured) {
            codeInput.disabled = true;
            rakeSelect.disabled = true;
            saveBtn.disabled = true;
            showStatus('Affiliate settings locked');
          } else {
            codeInput.disabled = false;
            rakeSelect.disabled = false;
            saveBtn.disabled = false;
            showStatus('');
          }
        }

        async function fetchPlayer() {
          const now = Date.now();
          if (now - lastPlayerFetch < 1000) return;
          lastPlayerFetch = now;
          try {
            const res = await fetch(`${apiBase}/api/player`, {
              credentials: 'include',
            });
            if (!res.ok) return;
            const data = await res.json();
            applyPlayer(data.player);
          } catch {
            // ignore
          }
        }

        function toggleVisibility() {
          const ready = walletConnected() && discordConnected();
          const showConfig = ready && !affiliateConfigured;
          affiliateRow.classList.toggle('hidden', !showConfig);
          if (status) status.classList.toggle('hidden', !showConfig);
          if (ready) fetchPlayer();
        }

        saveBtn.addEventListener('click', async (event) => {
          event.preventDefault();
          const code = codeInput.value.trim().toUpperCase();
          const rakebackBps = Number(rakeSelect.value);
          if (!/^[A-Z0-9]{3,12}$/.test(code)) {
            showStatus('Code must be 3-12 letters or numbers');
            return;
          }
          if (!Number.isInteger(rakebackBps)) {
            showStatus('Invalid rakeback selection');
            return;
          }
          showStatus('Saving...');
          try {
            const res = await fetch(`${apiBase}/api/affiliate/config`, {
              method: 'POST',
              credentials: 'include',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ code, rakebackBps }),
            });
            if (!res.ok) {
              const text = await res.text();
              let message = 'Unable to save affiliate settings';
              try {
                const parsed = JSON.parse(text);
                if (parsed?.error) message = parsed.error;
              } catch {
                if (text) message = text;
              }
              showStatus(message);
              return;
            }
            const data = await res.json();
            applyPlayer(data.player);
            showStatus('Affiliate settings saved');
          } catch {
            showStatus('Unable to save affiliate settings');
          }
        });

        const walletEl = document.getElementById('wallet-address');
        const discordEl = document.getElementById('discord-user');
        if (walletEl) {
          new MutationObserver(toggleVisibility).observe(walletEl, {
            childList: true,
            subtree: true,
            characterData: true,
          });
        }
        if (discordEl) {
          new MutationObserver(toggleVisibility).observe(discordEl, {
            attributes: true,
            attributeFilter: ['class'],
          });
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', toggleVisibility, { once: true });
        } else {
          toggleVisibility();
        }
      })();
    </script>

    <script>
      (function () {
        const walletBtn = document.getElementById('wallet-connect-btn');
        const walletText = walletBtn?.querySelector('.btn-text');
        const walletAddress = document.getElementById('wallet-address');
        if (!walletBtn || !walletText || !walletAddress) return;

        function updateWalletCompact() {
          const addr = (walletAddress.textContent || '').trim();
          if (addr && addr !== 'Not connected') {
            walletText.textContent = addr;
            walletBtn.classList.add('wallet-connected');
            walletAddress.classList.add('compact-hidden');
            walletBtn.title = `Disconnect ${addr}`;
          } else {
            walletText.textContent = 'Connect Wallet';
            walletBtn.classList.remove('wallet-connected');
            walletAddress.classList.remove('compact-hidden');
            walletBtn.title = '';
          }
        }

        const observer = new MutationObserver(updateWalletCompact);
        observer.observe(walletAddress, { childList: true, characterData: true, subtree: true });
        updateWalletCompact();
      })();
    </script>

    <script>
      (function () {
        const discordBtn = document.getElementById('discord-connect-btn');
        const discordText = document.getElementById('discord-connect-text');
        const discordUser = document.getElementById('discord-user');
        const discordName = document.getElementById('discord-name');
        if (!discordBtn || !discordText || !discordUser || !discordName) return;

        function updateDiscordCompact() {
          const name = (discordName.textContent || '').trim();
          const connected = Boolean(name) && !discordUser.classList.contains('hidden');
          if (connected) {
            discordText.textContent = name;
            discordBtn.classList.add('discord-connected');
            discordUser.classList.add('compact-hidden');
            discordBtn.title = `Disconnect ${name}`;
          } else {
            discordText.textContent = 'Connect Discord';
            discordBtn.classList.remove('discord-connected');
            discordUser.classList.remove('compact-hidden');
            discordBtn.title = '';
          }
        }

        new MutationObserver(updateDiscordCompact).observe(discordUser, {
          attributes: true,
          attributeFilter: ['class'],
        });
        new MutationObserver(updateDiscordCompact).observe(discordName, {
          childList: true,
          characterData: true,
          subtree: true,
        });
        updateDiscordCompact();
      })();
    </script>

    <script>
      (function () {
        const netResultValue = document.getElementById('net-result-value');
        const netTokenValue = document.getElementById('net-result-token-value');
        const resultsContainer = document.getElementById('results-container');
        if (!netResultValue || !netTokenValue || !resultsContainer) return;

        const AudioCtx = window.AudioContext || window.webkitAudioContext;
        if (!AudioCtx) return;

        let audioCtx = null;
        let masterGain = null;
        let lastSignature = '';

        function initAudio() {
          if (audioCtx) return;
          audioCtx = new AudioCtx();
          masterGain = audioCtx.createGain();
          masterGain.gain.value = 0.06;
          masterGain.connect(audioCtx.destination);
        }

        async function resumeAudio() {
          if (!audioCtx || audioCtx.state !== 'suspended') return;
          try {
            await audioCtx.resume();
          } catch {
            // ignore
          }
        }

        function playTone(freq, duration, type, gain, when) {
          if (!audioCtx || !masterGain) return;
          const osc = audioCtx.createOscillator();
          const amp = audioCtx.createGain();
          osc.type = type || 'sine';
          osc.frequency.value = freq;
          amp.gain.value = 0;
          osc.connect(amp);
          amp.connect(masterGain);
          const start = audioCtx.currentTime + (when || 0);
          amp.gain.setValueAtTime(0, start);
          amp.gain.linearRampToValueAtTime(gain || 0.2, start + 0.01);
          amp.gain.exponentialRampToValueAtTime(0.0001, start + duration);
          osc.start(start);
          osc.stop(start + duration + 0.03);
        }

        function playMatchTicks(matchCount) {
          const count = Math.min(Math.max(matchCount, 0), 8);
          if (count <= 0) return;
          const base = 320;
          const step = 70;
          for (let i = 0; i < count; i += 1) {
            playTone(base + step * i, 0.06, 'square', 0.18, i * 0.08);
          }
        }

        function playWinChime() {
          playTone(660, 0.12, 'triangle', 0.22, 0.0);
          playTone(880, 0.12, 'triangle', 0.20, 0.12);
          playTone(1320, 0.16, 'triangle', 0.18, 0.24);
        }

        function handleSpinUpdate() {
          const matchesText = (netResultValue.textContent || '').trim();
          if (!matchesText || matchesText === '—') return;

          const netText = (netTokenValue.textContent || '').trim();
          const historyCount = resultsContainer.querySelectorAll('.history-item').length;
          const signature = `${matchesText}|${netText}|${historyCount}`;
          if (signature === lastSignature) return;
          lastSignature = signature;

          let matches = 0;
          let specialMatch = false;
          if (/special/i.test(matchesText)) {
            specialMatch = true;
            matches = 1;
          } else {
            const parsed = parseInt(matchesText, 10);
            matches = Number.isNaN(parsed) ? 0 : parsed;
          }

          playMatchTicks(matches);

          const isWin = netText.startsWith('+');
          if (isWin || specialMatch) {
            playWinChime();
          }
        }

        const observer = new MutationObserver(() => {
          handleSpinUpdate();
        });
        observer.observe(resultsContainer, { childList: true, subtree: true });
        observer.observe(netResultValue, { childList: true, characterData: true, subtree: true });
        observer.observe(netTokenValue, { childList: true, characterData: true, subtree: true });

        const unlock = () => {
          initAudio();
          resumeAudio();
          document.removeEventListener('pointerdown', unlock);
          document.removeEventListener('keydown', unlock);
        };
        document.addEventListener('pointerdown', unlock, { once: true });
        document.addEventListener('keydown', unlock, { once: true });
      })();
    </script>
  </body>
</html>
